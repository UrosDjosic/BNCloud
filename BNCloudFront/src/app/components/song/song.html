<div class="song-container" *ngIf="song">
  <mat-card class="song-card mat-elevation-z6">

    <div class="song-content">
      <!-- LEFT SIDE -->
      <div class="song-left">
        <!-- Header -->
        <div class="song-header">
          <img
            *ngIf="song.image"
            [src]="song.image"
            alt="{{ song.name }}"
            class="song-image"
          />
          <div class="song-title-meta">
            <h2 class="title">{{ song.name }}</h2>
            <p class="file-name">{{ song.fileName }}</p>
            <p class="genres" *ngIf="song.genres?.length">
              <strong>Genres:</strong>
              <span *ngFor="let g of song.genres; let last = last">
                {{ g.name }}<span *ngIf="!last">, </span>
              </span>
            </p>
          </div>
        </div>

        <!-- Player -->
        <div class="audio-player" *ngIf="song.audio">
          <audio [src]="song.audio" controls></audio>
        </div>

        <!-- Metadata -->
        <div class="metadata mat-subheading-1">
          <p><strong>Created At:</strong> {{ song.creationTime | date:'medium' }}</p>
          <p><strong>Last Modified:</strong> {{ song.modificationTime | date:'medium' }}</p>
          <p>
            <strong>Artists:</strong>
            <span *ngFor="let artist of song.artists; let last = last">
              <a *ngIf="artist.name" [routerLink]="['/artist', artist.id]">
                {{ artist.name }}
              </a>
              <span *ngIf="!artist.name">UNKNOWN</span>{{ last ? '' : ', ' }}
            </span>
          </p>
          <p>
            <strong>Ratings:</strong>
            <span *ngIf="song.avgRating; else noRatings">
              {{ avgRating }}
            </span>
            <ng-template #noRatings>Not rated yet</ng-template>
          </p>
        </div>

        <!-- Actions -->
        <div class="action-buttons">
          <button mat-stroked-button color="accent" (click)="selectUserList()">Add to My List</button>
          <button mat-stroked-button color="primary" (click)="cacheSongForOffline()">
            Save for offline
          </button>
          <button mat-stroked-button color="warn" (click)="removeOfflineCopy()">
            Remove offline copy
          </button>
          <div class="crud-buttons">
            <button mat-icon-button color="primary" (click)="editSong()" *ngIf="this.role === 'ADMINISTRATOR'">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="deleteSong()" *ngIf="this.role === 'ADMINISTRATOR'">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
        <div class="ratings" *ngIf="this.role === 'USER'">
          <p class="ratings-label"><strong>Rate this song:</strong></p>
          <div class="stars">
            <mat-icon
              *ngFor="let star of stars; let i = index"
              (click)="setRating(i + 1)"
              (mouseenter)="hoverRating = i + 1"
              (mouseleave)="hoverRating = 0"
              [ngClass]="{
                'filled': (hoverRating || currentRating) > i,
                'unfilled': (hoverRating || currentRating) <= i
              }"
            >
              star
            </mat-icon>
          </div>
        <p *ngIf="currentRating" class="rating-text">
          You selected {{ currentRating }} {{ currentRating === 1 ? 'star' : 'stars' }}.
        </p>
      </div>
    </div>
      <div *ngIf="showUserListDropdown" class="userlist-dropdown">
        <mat-form-field appearance="fill" color="accent">
          <mat-label>Select a list</mat-label>
          <mat-select (selectionChange)="onUserListSelected($event.value)">
            <mat-option *ngFor="let list of usersLists" [value]="list.id">
              {{ list.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
  </div>
    <!-- RIGHT SIDE -->
    <div class="song-right">
      <div class="transcription-box">
        <h3>Transcription</h3>
        <p *ngIf="!song.transcript">No text for this song...</p>
        <textarea *ngIf="song.transcript"
          class="transcription-textarea"
          [value]="song.transcript || ''"
          readonly
          placeholder="Song lyrics or transcription will appear here...">
          </textarea>
      </div>
    </div>
  </mat-card>
</div>
